{% extends "layout.html" %}
{% block content %}
  <section class="card">
    <div class="card-header">
      <h2>ðŸ§¾ Action Details</h2>
      <div class="button-row">
        {% if edit_mode %}
          <a class="button secondary" href="/ui/actions/{{ action.id }}">Cancel</a>
        {% else %}
          <a class="button" href="/ui/actions/{{ action.id }}?edit=1">Edit</a>
        {% endif %}
        <a class="button secondary" href="/ui/actions">Back to list</a>
      </div>
    </div>
    {% if edit_mode %}
      <form method="post" action="/ui/actions/{{ action.id }}/edit">
        <div class="form-grid">
          <label class="full-row">
            Title
            <input type="text" name="title" value="{{ action.title }}" required />
          </label>
          <label class="full-row">
            Description
            <textarea name="description" rows="3">{{ action.description or "" }}</textarea>
          </label>
          <label>
            Status
            <select name="status">
              {% for status in status_options %}
                <option value="{{ status }}" {% if action.status == status %}selected{% endif %}>{{ status }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            Champion
            <select name="champion_id">
              <option value="">â€”</option>
              {% for champion in champions %}
                <option value="{{ champion.id }}" {% if action.champion_id == champion.id %}selected{% endif %}>
                  {{ champion.full_name }}
                </option>
              {% endfor %}
            </select>
          </label>
          <label>
            Project
            <select name="project_id">
              <option value="">â€”</option>
              {% for project in projects %}
                <option value="{{ project.id }}" {% if action.project_id == project.id %}selected{% endif %}>{{ project.name }}</option>
              {% endfor %}
            </select>
          </label>
          <label>
            Owner
            <input type="text" name="owner" value="{{ action.owner or '' }}" />
          </label>
          <label>
            Due date
            <input type="date" name="due_date" value="{{ action.due_date.isoformat() if action.due_date else '' }}" />
          </label>
          <label>
            Priority
            <select name="priority">
              <option value="">â€”</option>
              {% for priority in priority_options %}
                <option value="{{ priority }}" {% if action.priority == priority %}selected{% endif %}>{{ priority }}</option>
              {% endfor %}
            </select>
          </label>
          <div><strong>Created at</strong><p>{{ format_date(action.created_at) }}</p></div>
          <div><strong>Closed at</strong><p>{{ format_date(action.closed_at) }}</p></div>
          <div><strong>Days late</strong><p>{{ days_late }}</p></div>
        </div>
        <div class="button-row mt-8">
          <button class="button" type="submit">Save</button>
          <a class="button secondary" href="/ui/actions/{{ action.id }}">Cancel</a>
        </div>
      </form>
    {% else %}
      <h3>{{ action.title }}</h3>
      <p class="muted">{{ action.description or "No description provided." }}</p>
      <div class="detail-grid">
        <div><strong>Status</strong><p><span class="status-badge status-{{ action.status|lower }}">{{ action.status }}</span></p></div>
        <div><strong>Champion</strong><p>{{ action.champion.full_name if action.champion else "â€”" }}</p></div>
        <div><strong>Project</strong><p>{{ action.project.name if action.project else "â€”" }}</p></div>
        <div><strong>Owner</strong><p>{{ action.owner or "â€”" }}</p></div>
        <div><strong>Due date</strong><p>{{ format_date(action.due_date) }}</p></div>
        <div><strong>Priority</strong><p>{{ action.priority or "â€”" }}</p></div>
        <div><strong>Created at</strong><p>{{ format_date(action.created_at) }}</p></div>
        <div><strong>Closed at</strong><p>{{ format_date(action.closed_at) }}</p></div>
        <div><strong>Days late</strong><p>{{ days_late }}</p></div>
      </div>
    {% endif %}

    <div class="card card-compact mt-16">
      <h4>Tags</h4>
      {% if action.tags %}
        <div class="tag-list">
          {% for tag in action.tags %}
            <form method="post" action="/ui/actions/{{ action.id }}/tags/{{ tag.id }}/delete" class="tag-form">
              <span class="tag-chip" {% if tag.color %}style="--tag-color: {{ tag.color }}"{% endif %}>{{ tag.name }}</span>
              <button class="tag-remove" type="submit">Ã—</button>
            </form>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">No tags yet.</p>
      {% endif %}
      <form method="post" action="/ui/actions/{{ action.id }}/tags" class="form-inline mt-8">
        <label>
          Add tag
          <input type="text" name="tag_name" list="action-tags-list" placeholder="Type or create tag" required />
        </label>
        <datalist id="action-tags-list">
          {% for tag in all_tags %}<option value="{{ tag.name }}"></option>{% endfor %}
        </datalist>
        <button class="button secondary" type="submit">Add</button>
      </form>
    </div>

    <form method="post" action="/ui/actions/{{ action.id }}/delete">
      <button class="button danger" type="submit">Delete action</button>
    </form>
  </section>
  {% include "partials/subtasks.html" %}
{% endblock %}
