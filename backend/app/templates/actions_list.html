{% extends "layout.html" %}
{% block content %}
  <section class="actions-page">
    {% include "partials/flash.html" %}

    <header class="actions-header">
      <div>
        <h2>Actions</h2>
        <p class="muted">Track execution health, ownership, and delivery risk in one place.</p>
      </div>
      <div class="button-row">
        <button
          class="button secondary"
          hx-get="/ui/actions/_table"
          hx-target="#actions-table"
          hx-swap="outerHTML"
        >
          Refresh
        </button>
        <button class="button" type="button" data-open-create-action>
          + Create action
        </button>
      </div>
    </header>

    <section class="actions-section">
      <div class="kpi-grid kpi-grid-actions">
        <div class="kpi-card">
          <span class="kpi-label">Open actions</span>
          <span class="kpi-value">{{ kpi.open_count }}</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Overdue actions</span>
          <span class="kpi-value">{{ kpi.overdue_count }}</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">On-time close rate</span>
          <span class="kpi-value">{{ "%.0f"|format(kpi.on_time_close_rate) }}%</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Avg time to close (days)</span>
          <span class="kpi-value">{{ "%.1f"|format(kpi.avg_time_to_close_days) }}</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-label">Sum days late</span>
          <span class="kpi-value">{{ kpi.sum_days_late }}</span>
        </div>
      </div>
    </section>

    <section class="actions-section filters-panel">
      <form
        id="actions-filter-form"
        class="actions-filter-form"
        method="get"
        action="/ui/actions"
        hx-get="/ui/actions/_table"
        hx-target="#actions-table"
        hx-swap="outerHTML"
        hx-push-url="true"
      >
        <input type="hidden" name="page" value="1" />
        <label>
          Search
          <input type="text" name="q" value="{{ filters.q }}" placeholder="Title or description" />
        </label>
        <label>
          Status
          <select name="status" multiple>
            {% for status in status_options %}
              <option value="{{ status }}" {% if status in filters.status %}selected{% endif %}>{{ status }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Project
          <select name="project_id">
            <option value="">All projects</option>
            {% for project in projects %}
              <option value="{{ project.id }}" {% if filters.project_id == project.id %}selected{% endif %}>{{ project.name }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Champion
          <select name="champion_id">
            <option value="">All champions</option>
            {% for champion in champions %}
              <option value="{{ champion.id }}" {% if filters.champion_id == champion.id %}selected{% endif %}>{{ champion.full_name }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Tags
          <select name="tags" multiple>
            {% for tag in all_tags %}
              <option value="{{ tag.name }}" {% if tag.name in filters.tags %}selected{% endif %}>{{ tag.name }}</option>
            {% endfor %}
          </select>
        </label>

        <details class="actions-filter-more">
          <summary>More filters</summary>
          <div class="actions-filter-more-grid">
            <label>
              Due from
              <input type="date" name="from" value="{{ filters.from }}" />
            </label>
            <label>
              Due to
              <input type="date" name="to" value="{{ filters.to }}" />
            </label>
            <label>
              Sort
              <select name="sort">
                <option value="">Default</option>
                {% for value, label in sort_options %}
                  <option value="{{ value }}" {% if filters.sort == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </label>
            <label>
              Page size
              <select name="page_size">
                {% for size in [10, 25, 50, 100] %}
                  <option value="{{ size }}" {% if filters.page_size == size %}selected{% endif %}>{{ size }}</option>
                {% endfor %}
              </select>
            </label>
          </div>
        </details>

        <div class="form-actions">
          <button class="button secondary" type="submit">Apply filters</button>
        </div>
      </form>
    </section>

    <section class="actions-section actions-table-panel">
      {% include "partials/actions_table.html" %}
    </section>
  </section>

  <div class="modal-shell" id="create-action-modal" hidden>
    <div class="modal-backdrop" data-close-create-action></div>
    <aside class="create-action-panel" role="dialog" aria-modal="true" aria-labelledby="create-action-title">
      <div class="create-action-header">
        <h3 id="create-action-title">Create action</h3>
        <button class="button secondary" type="button" data-close-create-action>Close</button>
      </div>
      <p class="muted">Add a new corrective action without leaving the list.</p>
      <form class="form-grid" id="create-action-form" method="post" action="/ui/actions">
        <label>
          Title
          <input type="text" name="title" placeholder="Action title" required />
        </label>
        <label>
          Description
          <textarea name="description" rows="3" placeholder="Why this action matters"></textarea>
        </label>
        <label>
          Owner
          <input type="text" name="owner" placeholder="Owner name" />
        </label>
        <label>
          Status
          <select name="status">
            {% for status in status_options %}
              <option value="{{ status }}">{{ status }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Project
          <select name="project_id">
            <option value="">All projects</option>
            {% for project in projects %}
              <option value="{{ project.id }}">{{ project.name }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Champion
          <select name="champion_id">
            <option value="">All champions</option>
            {% for champion in champions %}
              <option value="{{ champion.id }}">{{ champion.full_name }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Due date
          <input type="date" name="due_date" />
        </label>
        <label>
          Tags (comma separated)
          <input type="text" name="tags" placeholder="scrap, downtime" />
        </label>
        <div class="form-actions">
          <button class="button" type="submit">Save action</button>
        </div>
      </form>
    </aside>
  </div>

  <script>
    (() => {
      const modal = document.getElementById("create-action-modal");
      const openButton = document.querySelector("[data-open-create-action]");
      const closeButtons = document.querySelectorAll("[data-close-create-action]");
      const createForm = document.getElementById("create-action-form");
      const filtersForm = document.getElementById("actions-filter-form");

      const openModal = () => {
        modal.hidden = false;
        document.body.classList.add("no-scroll");
      };

      const closeModal = () => {
        modal.hidden = true;
        document.body.classList.remove("no-scroll");
      };

      openButton?.addEventListener("click", openModal);
      closeButtons.forEach((button) => button.addEventListener("click", closeModal));
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && !modal.hidden) {
          closeModal();
        }
      });

      createForm?.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(createForm);
        const response = await fetch(createForm.action, {
          method: "POST",
          body: formData,
        });
        if (!response.ok) {
          window.location.assign("/ui/actions");
          return;
        }
        createForm.reset();
        closeModal();
        if (window.htmx && filtersForm) {
          window.htmx.trigger(filtersForm, "submit");
        } else {
          window.location.reload();
        }
      });
    })();
  </script>
{% endblock %}
