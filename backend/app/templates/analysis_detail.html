{% extends "layout.html" %}
{% block content %}
  <section class="card">
    <div class="card-header">
      <h2>üîç Analysis {{ analysis.id }}</h2>
      <div class="button-row">
        <a class="button secondary" href="/ui/analyses">Back to list</a>
      </div>
    </div>
    {% include "partials/flash_message.html" %}

    <div class="detail-grid">
      <div>
        <span class="kpi-label">Template</span>
        <strong>{{ analysis.type }}</strong>
      </div>
      <div>
        <span class="kpi-label">Status</span>
        <strong>{{ analysis.status or 'Open' }}</strong>
      </div>
      <div>
        <span class="kpi-label">Champion</span>
        <strong>{{ analysis.champion or '‚Äî' }}</strong>
      </div>
      <div>
        <span class="kpi-label">Created</span>
        <strong>{{ format_date(analysis.created_at) }}</strong>
      </div>
    </div>

    <h3>{{ analysis.title or 'Untitled analysis' }}</h3>
    <p>{{ analysis.description or 'No description yet.' }}</p>

    <div class="card mt-16">
      <h4>Template sections</h4>
      {% if analysis.type == '5WHY' %}
        {% set details = analysis.details_5why %}
        <form method="post" action="/ui/analyses/{{ analysis.id }}/save-5why" class="stack-lg">
          <div class="card card-compact">
            <h5>SECTION 1 ‚Äì Problem definition</h5>
            <label>
              Problem statement *
              <textarea name="problem_statement" rows="3" required>{{ details.problem_statement if details else '' }}</textarea>
            </label>
            <label>
              Where observed
              <input type="text" name="where_observed" value="{{ details.where_observed if details else '' }}" />
            </label>
            <label>
              Date detected
              <input type="date" name="date_detected" value="{{ details.date_detected.isoformat() if details and details.date_detected else '' }}" />
            </label>
          </div>

          <div class="card card-compact">
            <h5>SECTION 2 ‚Äì Why ladder</h5>
            <label>Why 1: Why did the problem occur?
              <textarea name="why_1" rows="3">{{ details.why_1 if details else '' }}</textarea>
            </label>
            <label>Why 2: Why did Why 1 occur?
              <textarea name="why_2" rows="3">{{ details.why_2 if details else '' }}</textarea>
            </label>
            <label>Why 3: Why did Why 2 occur?
              <textarea name="why_3" rows="3">{{ details.why_3 if details else '' }}</textarea>
            </label>
            <label>Why 4: Why did Why 3 occur?
              <textarea name="why_4" rows="3">{{ details.why_4 if details else '' }}</textarea>
            </label>
            <label>Why 5: Why did Why 4 occur?
              <textarea name="why_5" rows="3">{{ details.why_5 if details else '' }}</textarea>
            </label>
          </div>

          <div class="card card-compact">
            <h5>SECTION 3 ‚Äì Root cause</h5>
            <label>
              Root cause *
              <textarea name="root_cause" rows="3" required>{{ details.root_cause if details else '' }}</textarea>
            </label>
            <label>
              Root cause category
              <select name="root_cause_category">
                <option value="">Select category</option>
                {% for category in root_cause_categories %}
                  <option value="{{ category }}" {% if details and details.root_cause_category == category %}selected{% endif %}>{{ category }}</option>
                {% endfor %}
              </select>
            </label>
          </div>

          <div class="card card-compact">
            <h5>SECTION 4 ‚Äì Containment action (optional)</h5>
            <label>
              Immediate containment
              <textarea name="containment_action" rows="3">{{ details.containment_action if details else '' }}</textarea>
            </label>
          </div>

          <div class="card card-compact">
            <h5>SECTION 5 ‚Äì Corrective action proposal</h5>
            <label>
              Proposed corrective action
              <textarea name="proposed_action" rows="3">{{ details.proposed_action if details else '' }}</textarea>
            </label>
            <div class="button-row mt-8">
              <button class="button" type="submit">Save analysis</button>
            </div>
          </div>
        </form>

        <form method="post" action="/ui/analyses/{{ analysis.id }}/create-action" class="mt-16">
          <button class="button" type="submit">Create Action from this Analysis</button>
        </form>
      {% elif analysis.type == '8D' %}
        <p class="muted">Placeholder for 8D sections (team, problem, containment, root cause, corrective actions).</p>
      {% elif analysis.type == 'A3' %}
        <p class="muted">Placeholder for A3 narrative (plan, do, check, act).</p>
      {% elif analysis.type == 'ISHIKAWA' %}
        <p class="muted">Placeholder for Ishikawa fishbone categories and notes.</p>
      {% else %}
        <p class="muted">Template details coming soon.</p>
      {% endif %}
    </div>


    <div class="card mt-16">
      <h4>Tags</h4>
      {% if analysis.tags %}
        <div class="tag-list">
          {% for tag in analysis.tags %}
            <form method="post" action="/ui/analyses/{{ analysis.id }}/tags/{{ tag.id }}/delete" class="tag-form">
              <span class="tag-chip" {% if tag.color %}style="--tag-color: {{ tag.color }}"{% endif %}>{{ tag.name }}</span>
              <button class="tag-remove" type="submit">√ó</button>
            </form>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">No tags yet.</p>
      {% endif %}
      <form method="post" action="/ui/analyses/{{ analysis.id }}/tags" class="form-inline">
        <label>
          Add tag
          <input type="text" name="tag_name" list="analysis-tags-list" placeholder="Type or create tag" required />
        </label>
        <datalist id="analysis-tags-list">
          {% for tag in all_tags %}<option value="{{ tag.name }}"></option>{% endfor %}
        </datalist>
        <button class="button secondary" type="submit">Add</button>
      </form>
    </div>

    <div class="card mt-16">
      <h4>Linked actions</h4>
      {% if analysis.actions %}
        <ul>
          {% for action in analysis.actions %}
            <li><a href="/ui/actions/{{ action.id }}">#{{ action.id }} ‚Äî {{ action.title }}</a></li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No linked actions yet.</p>
      {% endif %}
    </div>
  </section>
{% endblock %}
