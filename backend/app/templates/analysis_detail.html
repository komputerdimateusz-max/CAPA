{% extends "layout.html" %}
{% block content %}
  <section class="card">
    <div class="card-header">
      <h2>üîç Analysis {{ analysis.id }}</h2>
      <div class="button-row">
        <a class="button secondary" href="/ui/analyses">Back to list</a>
      </div>
    </div>
    {% include "partials/flash_message.html" %}

    <div class="detail-grid">
      <div>
        <span class="kpi-label">Template</span>
        <strong>{{ analysis.type }}</strong>
      </div>
      <div>
        <span class="kpi-label">Status</span>
        <strong>{{ analysis.status or 'Open' }}</strong>
      </div>
      <div>
        <span class="kpi-label">Champion</span>
        <strong>{{ analysis.champion or '‚Äî' }}</strong>
      </div>
      <div>
        <span class="kpi-label">Created</span>
        <strong>{{ format_date(analysis.created_at) }}</strong>
      </div>
      {% if analysis.type == '5WHY' and analysis.details_5why and analysis.details_5why.observed_process_type %}
        <div>
          <span class="kpi-label">Observed</span>
          <strong>{{ observed_process_labels.get(analysis.details_5why.observed_process_type, analysis.details_5why.observed_process_type) }} ‚Äî {{ observed_components_count }} component{% if observed_components_count != 1 %}s{% endif %}</strong>
        </div>
      {% endif %}
    </div>

    <h3>{{ analysis.title or 'Untitled analysis' }}</h3>
    <p>{{ analysis.description or 'No description yet.' }}</p>

    <div class="card mt-16">
      <h4>Template sections</h4>
      {% if analysis.type == '5WHY' %}
        {% set details = analysis.details_5why %}
        <form method="post" action="/ui/analyses/{{ analysis.id }}/save-5why" class="stack-lg">
          <div class="card card-compact">
            <h5>SECTION 1 ‚Äì Problem definition</h5>
            <label>
              Problem statement *
              <textarea name="problem_statement" rows="3" required>{{ details.problem_statement if details else '' }}</textarea>
            </label>
            <input type="hidden" name="where_observed" value="{{ details.where_observed if details else '' }}" />
            <div>
              <label>
                Observed area
                <select name="observed_process_type">
                  <option value="">Select area</option>
                  {% for process_type, process_label in observed_process_labels.items() %}
                    <option value="{{ process_type }}" {% if details and details.observed_process_type == process_type %}selected{% endif %}>{{ process_label }}</option>
                  {% endfor %}
                </select>
              </label>
              <button class="button secondary mt-8" type="submit" formaction="/ui/analyses/{{ analysis.id }}/observed/set-process">Set observed area</button>

            </div>
            <label>
              Date detected
              <input type="date" name="date_detected" value="{{ details.date_detected.isoformat() if details and details.date_detected else '' }}" />
            </label>
          </div>

          <div class="card card-compact">
            <h5>SECTION 2 ‚Äì Why ladder</h5>
            <label>Why 1: Why did the problem occur?
              <textarea name="why_1" rows="3">{{ details.why_1 if details else '' }}</textarea>
            </label>
            <label>Why 2: Why did Why 1 occur?
              <textarea name="why_2" rows="3">{{ details.why_2 if details else '' }}</textarea>
            </label>
            <label>Why 3: Why did Why 2 occur?
              <textarea name="why_3" rows="3">{{ details.why_3 if details else '' }}</textarea>
            </label>
            <label>Why 4: Why did Why 3 occur?
              <textarea name="why_4" rows="3">{{ details.why_4 if details else '' }}</textarea>
            </label>
            <label>Why 5: Why did Why 4 occur?
              <textarea name="why_5" rows="3">{{ details.why_5 if details else '' }}</textarea>
            </label>
          </div>

          <div class="card card-compact">
            <h5>SECTION 3 ‚Äì Root cause</h5>
            <label>
              Root cause *
              <textarea name="root_cause" rows="3" required>{{ details.root_cause if details else '' }}</textarea>
            </label>
            <label>
              Root cause category
              <select name="root_cause_category">
                <option value="">Select category</option>
                {% for category in root_cause_categories %}
                  <option value="{{ category }}" {% if details and details.root_cause_category == category %}selected{% endif %}>{{ category }}</option>
                {% endfor %}
              </select>
            </label>
          </div>

          <div class="card card-compact">
            <h5>SECTION 4 ‚Äì Containment action (optional)</h5>
            <label>
              Immediate containment
              <textarea name="containment_action" rows="3">{{ details.containment_action if details else '' }}</textarea>
            </label>
          </div>

          <div class="card card-compact">
            <h5>SECTION 5 ‚Äì Corrective action proposal</h5>
            <label>
              Proposed corrective action
              <textarea name="proposed_action" rows="3">{{ details.proposed_action if details else '' }}</textarea>
            </label>
            <div class="button-row mt-8">
              <button class="button" type="submit">Save analysis</button>
            </div>
          </div>
        </form>

        <div class="card card-compact mt-16">
          <h5>Observed components</h5>
          {% if details and details.observed_process_type == 'assembly' %}
            <h6>Observed references</h6>
            <form method="post" action="/ui/analyses/{{ analysis.id }}/observed/assembly-references/add" class="form-inline mt-8">
              <label>
                Reference
                <input type="text" name="reference_id" list="observed-assembly-reference-options" placeholder="Type reference name / FG code..." autocomplete="off" />
              </label>
              <datalist id="observed-assembly-reference-options">
                {% for reference in assembly_references %}
                  <option value="{{ reference.id }}">{{ reference.reference_name }} ‚Äî FG: {{ reference.fg_material.part_number if reference.fg_material else '‚Äî' }} ‚Äî Line: {{ reference.line.line_number if reference.line else '‚Äî' }}</option>
                {% endfor %}
              </datalist>
              <button class="button secondary" type="submit">Add reference</button>
            </form>
            <div class="tag-list mt-8">
              {% for reference in details.assembly_references %}
                <form method="post" action="/ui/analyses/{{ analysis.id }}/observed/assembly-references/remove" class="tag-form">
                  <input type="hidden" name="reference_id" value="{{ reference.id }}" />
                  <span class="tag-chip">{{ reference.reference_name }}</span>
                  <button class="tag-remove" type="submit">√ó</button>
                </form>
              {% endfor %}
            </div>
          {% elif details and details.observed_process_type == 'moulding' %}
            <h6>Observed moulding tools</h6>
            <form method="post" action="/ui/analyses/{{ analysis.id }}/observed/moulding-tools/add" class="form-inline mt-8">
              <label>
                Tool
                <input type="text" name="tool_pn" list="observed-moulding-tool-options" placeholder="Type tool PN" autocomplete="off" />
              </label>
              <datalist id="observed-moulding-tool-options">
                {% for tool in moulding_tools %}
                  <option value="{{ tool.tool_pn }}">{{ tool.tool_pn }} ‚Äî {{ tool.description or 'No description' }}</option>
                {% endfor %}
              </datalist>
              <button class="button secondary" type="submit">Add tool</button>
            </form>
            <div class="tag-list mt-8">
              {% for tool in details.moulding_tools %}
                <form method="post" action="/ui/analyses/{{ analysis.id }}/observed/moulding-tools/remove" class="tag-form">
                  <input type="hidden" name="tool_id" value="{{ tool.id }}" />
                  <span class="tag-chip">{{ tool.tool_pn }}</span>
                  <button class="tag-remove" type="submit">√ó</button>
                </form>
              {% endfor %}
            </div>
          {% elif details and details.observed_process_type == 'metalization' %}
            <h6>Observed masks</h6>
            <form method="post" action="/ui/analyses/{{ analysis.id }}/observed/metalization-masks/add" class="form-inline mt-8">
              <label>
                Mask
                <input type="text" name="mask_pn" list="observed-metalization-mask-options" placeholder="Type mask PN" autocomplete="off" />
              </label>
              <datalist id="observed-metalization-mask-options">
                {% for mask in metalization_masks %}
                  <option value="{{ mask.mask_pn }}">{{ mask.mask_pn }} ‚Äî {{ mask.description or 'No description' }}</option>
                {% endfor %}
              </datalist>
              <button class="button secondary" type="submit">Add mask</button>
            </form>
            <div class="tag-list mt-8">
              {% for mask in details.metalization_masks %}
                <form method="post" action="/ui/analyses/{{ analysis.id }}/observed/metalization-masks/remove" class="tag-form">
                  <input type="hidden" name="mask_id" value="{{ mask.id }}" />
                  <span class="tag-chip">{{ mask.mask_pn }}</span>
                  <button class="tag-remove" type="submit">√ó</button>
                </form>
              {% endfor %}
            </div>
          {% else %}
            <p class="muted">Select observed area first.</p>
          {% endif %}
        </div>

        <form method="post" action="/ui/analyses/{{ analysis.id }}/create-action" class="mt-16">
          <button class="button" type="submit">Create Action from this Analysis</button>
        </form>
      {% elif analysis.type == '8D' %}
        <p class="muted">Placeholder for 8D sections (team, problem, containment, root cause, corrective actions).</p>
      {% elif analysis.type == 'A3' %}
        <p class="muted">Placeholder for A3 narrative (plan, do, check, act).</p>
      {% elif analysis.type == 'ISHIKAWA' %}
        <p class="muted">Placeholder for Ishikawa fishbone categories and notes.</p>
      {% else %}
        <p class="muted">Template details coming soon.</p>
      {% endif %}
    </div>


    <div class="card mt-16">
      <h4>Tags</h4>
      {% if analysis.tags %}
        <div class="tag-list">
          {% for tag in analysis.tags %}
            <form method="post" action="/ui/analyses/{{ analysis.id }}/tags/{{ tag.id }}/delete" class="tag-form">
              <span class="tag-chip" {% if tag.color %}style="--tag-color: {{ tag.color }}"{% endif %}>{{ tag.name }}</span>
              <button class="tag-remove" type="submit">√ó</button>
            </form>
          {% endfor %}
        </div>
      {% else %}
        <p class="muted">No tags yet.</p>
      {% endif %}
      <form method="post" action="/ui/analyses/{{ analysis.id }}/tags" class="form-inline">
        <label>
          Add tag
          <input type="text" name="tag_name" list="analysis-tags-list" placeholder="Type or create tag" required />
        </label>
        <datalist id="analysis-tags-list">
          {% for tag in all_tags %}<option value="{{ tag.name }}"></option>{% endfor %}
        </datalist>
        <button class="button secondary" type="submit">Add</button>
      </form>
    </div>

    <div class="card mt-16">
      <h4>Linked actions</h4>
      {% if analysis.actions %}
        <ul>
          {% for action in analysis.actions %}
            <li><a href="/ui/actions/{{ action.id }}">#{{ action.id }} ‚Äî {{ action.title }}</a></li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No linked actions yet.</p>
      {% endif %}
    </div>
  </section>
{% endblock %}
