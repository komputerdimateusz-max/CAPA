{% extends "layout.html" %}
{% block content %}
  <div class="settings-page">
    <section class="card">
      <div class="card-header">
        <h2>⚙️ Global Settings</h2>
        <p class="muted">Manage shared reference data for actions, projects, and champions.</p>
      </div>
      {% include "partials/flash_message.html" %}

      <div class="detail-grid settings-grid">
        <div class="card card-compact settings-card">
        <div class="card-header">
          <h3>Champions</h3>
          <div class="button-row">
            <button class="button" type="button" data-open-modal="champion">Add champion</button>
          </div>
        </div>

        {% if champions %}
          <form class="form-grid" method="get" action="/ui/settings">
            <label>
              Select champion to edit
              <select name="champion_id" onchange="this.form.submit()">
                <option value="">Choose champion</option>
                {% for champion in champions %}
                  <option value="{{ champion.id }}" {% if selected_champion and selected_champion.id == champion.id %}selected{% endif %}>
                    {{ champion.full_name }}
                  </option>
                {% endfor %}
              </select>
            </label>
            {% if selected_project %}
              <input type="hidden" name="project_id" value="{{ selected_project.id }}" />
            {% endif %}
          </form>

          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Position</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for champion in champions %}
                  <tr>
                    <td>{{ champion.full_name }}</td>
                    <td>{{ champion.email or '—' }}</td>
                    <td>{{ champion.position or '—' }}</td>
                    <td>
                      <a class="button secondary" href="/ui/settings?champion_id={{ champion.id }}">Edit</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted">No champions yet. Use Add champion to create one.</p>
        {% endif %}

        {% if selected_champion %}
          <div class="card mt-16">
            <h4>Edit champion</h4>
            <form class="form-grid" method="post" action="/ui/settings/champions/{{ selected_champion.id }}">
              <label>
                First name
                <input
                  type="text"
                  name="first_name"
                  required
                  value="{{ form.champion_first_name or selected_champion.first_name }}"
                />
              </label>
              <label>
                Last name
                <input
                  type="text"
                  name="last_name"
                  required
                  value="{{ form.champion_last_name or selected_champion.last_name }}"
                />
              </label>
              <label>
                Email
                <input
                  type="email"
                  name="email"
                  value="{{ form.champion_email or selected_champion.email or '' }}"
                />
              </label>
              <label>
                Position
                <input
                  type="text"
                  name="position"
                  value="{{ form.champion_position or selected_champion.position or '' }}"
                />
              </label>
              <label>
                Birth date
                <input
                  type="date"
                  name="birth_date"
                  value="{{ form.champion_birth_date or (selected_champion.birth_date.isoformat() if selected_champion.birth_date else '') }}"
                />
              </label>
              <div class="form-actions">
                <button class="button" type="submit">Save champion</button>
              </div>
            </form>
          </div>
        {% endif %}
      </div>

        <div class="card card-compact settings-card">
        <div class="card-header">
          <h3>Projects</h3>
          <div class="button-row">
            <button class="button" type="button" data-open-modal="project">Add project</button>
          </div>
        </div>

        {% if projects %}
          <form class="form-grid" method="get" action="/ui/settings">
            <label>
              Select project to edit
              <select name="project_id" onchange="this.form.submit()">
                <option value="">Choose project</option>
                {% for project in projects %}
                  <option value="{{ project.id }}" {% if selected_project and selected_project.id == project.id %}selected{% endif %}>
                    {{ project.name }}
                  </option>
                {% endfor %}
              </select>
            </label>
            {% if selected_champion %}
              <input type="hidden" name="champion_id" value="{{ selected_champion.id }}" />
            {% endif %}
          </form>

          <div class="table-wrap">
            <table class="table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Status</th>
                  <th>Max Volume</th>
                  <th>Flex</th>
                  <th>Process Engineer</th>
                  <th>Due</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for project in projects %}
                  <tr>
                    <td>{{ project.name }}</td>
                    <td>{{ project.status or '—' }}</td>
                    <td>{{ project.max_volume if project.max_volume is not none else '—' }}</td>
                    <td>{% if project.flex_percent is not none %}{{ project.flex_percent }}%{% else %}—{% endif %}</td>
                    <td>{{ project.process_engineer.full_name if project.process_engineer else '—' }}</td>
                    <td>{{ format_date(project.due_date) }}</td>
                    <td>
                      <a class="button secondary" href="/ui/settings?project_id={{ project.id }}">Edit</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted">No projects yet. Use Add project to create one.</p>
        {% endif %}

        {% if selected_project %}
          <div class="card mt-16">
            <h4>Edit project</h4>
            <form class="form-grid" method="post" action="/ui/settings/projects/{{ selected_project.id }}">
              <label>
                Name
                <input
                  type="text"
                  name="name"
                  value="{{ form.project_name or selected_project.name }}"
                />
              </label>
              <label>
                Status
                <select name="status" required>
                  <option value="">Select status</option>
                  {% set selected_status = form.project_status or selected_project.status or '' %}
                  {% for option in project_status_options %}
                    <option value="{{ option }}" {% if selected_status == option %}selected{% endif %}>{{ option }}</option>
                  {% endfor %}
                </select>
              </label>
              <label>
                Max Volume [parts/year]
                <input type="number" name="max_volume" min="0" step="1" required value="{{ form.project_max_volume or (selected_project.max_volume if selected_project.max_volume is not none else '') }}" />
              </label>
              <label>
                Flex [%]
                <input type="number" name="flex_percent" min="0" max="100" step="0.01" required value="{{ form.project_flex_percent or (selected_project.flex_percent if selected_project.flex_percent is not none else '') }}" />
              </label>
              <label>
                Process Engineer
                {% set selected_engineer = form.project_process_engineer_id or (selected_project.process_engineer_id|string if selected_project.process_engineer_id else '') %}
                <select name="process_engineer_id" required>
                  <option value="">Select process engineer</option>
                  {% for champion in champions %}
                    <option value="{{ champion.id }}" {% if selected_engineer == champion.id|string %}selected{% endif %}>{{ champion.full_name }}</option>
                  {% endfor %}
                </select>
              </label>
              <label>
                Due date
                <input
                  type="date"
                  name="due_date"
                  value="{{ form.project_due_date or (selected_project.due_date.isoformat() if selected_project.due_date else '') }}"
                />
              </label>
              <div class="form-actions">
                <button class="button" type="submit">Save project</button>
              </div>
            </form>
          </div>
        {% endif %}
      </div>

        <div class="card card-compact settings-card">
        <div class="card-header">
          <h3>Users</h3>
        </div>

        {% if users %}
          <div class="table-wrap users-table-wrap">
            <table class="table users-table">
              <thead>
                <tr>
                  <th class="users-col-email">Email</th>
                  <th class="users-col-current-role">Current role</th>
                  <th class="users-col-change-role">Change role</th>
                  <th class="users-col-action"></th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                  <tr>
                    <td>{{ user.email }}</td>
                    <td><span class="status-pill">{{ user.role }}</span></td>
                    <td>
                      <form id="user-role-form-{{ user.id }}" class="inline-form users-role-form" method="post" action="/ui/settings/users/{{ user.id }}/role">
                        <select name="role">
                          {% for role in user_role_options %}
                            <option value="{{ role }}" {% if role == user.role %}selected{% endif %}>{{ role|title }}</option>
                          {% endfor %}
                        </select>
                      </form>
                    </td>
                    <td class="users-action-cell">
                      <button class="button users-save-button" type="submit" form="user-role-form-{{ user.id }}">Save</button>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="muted">No users found.</p>
        {% endif %}
      </div>
      </div>
    </section>
  </div>

  <div class="modal-shell" id="champion-modal" hidden>
    <div class="modal-backdrop" data-close-modal="champion"></div>
    <aside class="create-action-panel" role="dialog" aria-modal="true" aria-labelledby="champion-modal-title">
      <div class="create-action-header">
        <h3 id="champion-modal-title">Add champion</h3>
        <button class="button secondary" type="button" data-close-modal="champion">Cancel</button>
      </div>
      <p class="muted">Create a new champion for ownership and assignments.</p>
      <form class="form-grid" method="post" action="/ui/settings/champions">
        <label>
          First name
          <input
            type="text"
            name="first_name"
            required
            placeholder="e.g. Alex"
            value="{{ form.champion_first_name or '' }}"
          />
        </label>
        <label>
          Last name
          <input
            type="text"
            name="last_name"
            required
            placeholder="e.g. Martin"
            value="{{ form.champion_last_name or '' }}"
          />
        </label>
        <label>
          Email
          <input
            type="email"
            name="email"
            placeholder="alex@example.com"
            value="{{ form.champion_email or '' }}"
          />
        </label>
        <label>
          Position
          <input
            type="text"
            name="position"
            placeholder="Process Engineer"
            value="{{ form.champion_position or '' }}"
          />
        </label>
        <label>
          Birth date
          <input type="date" name="birth_date" value="{{ form.champion_birth_date or '' }}" />
        </label>
        <div class="form-actions">
          <button class="button" type="submit">Save champion</button>
          <button class="button secondary" type="button" data-close-modal="champion">Cancel</button>
        </div>
      </form>
    </aside>
  </div>

  <div class="modal-shell" id="project-modal" hidden>
    <div class="modal-backdrop" data-close-modal="project"></div>
    <aside class="create-action-panel" role="dialog" aria-modal="true" aria-labelledby="project-modal-title">
      <div class="create-action-header">
        <h3 id="project-modal-title">Add project</h3>
        <button class="button secondary" type="button" data-close-modal="project">Cancel</button>
      </div>
      <p class="muted">Create a project to group and track related CAPA actions.</p>
      <form class="form-grid" method="post" action="/ui/settings/projects">
        <label>
          Project name
          <input type="text" name="name" required placeholder="e.g. Line 2 Upgrade" value="{{ form.project_name or '' }}" />
        </label>
        <label>
          Status
          <select name="status" required>
            <option value="">Select status</option>
            {% for option in project_status_options %}
              <option value="{{ option }}" {% if (form.project_status or '') == option %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Max Volume [parts/year]
          <input type="number" name="max_volume" min="0" step="1" required value="{{ form.project_max_volume or '' }}" />
        </label>
        <label>
          Flex [%]
          <input type="number" name="flex_percent" min="0" max="100" step="0.01" required value="{{ form.project_flex_percent or '' }}" />
        </label>
        <label>
          Process Engineer
          <select name="process_engineer_id" required>
            <option value="">Select process engineer</option>
            {% for champion in champions %}
              <option value="{{ champion.id }}" {% if (form.project_process_engineer_id or '') == champion.id|string %}selected{% endif %}>{{ champion.full_name }}</option>
            {% endfor %}
          </select>
        </label>
        <label>
          Due date
          <input type="date" name="due_date" value="{{ form.project_due_date or '' }}" />
        </label>
        <div class="form-actions">
          <button class="button" type="submit">Save project</button>
          <button class="button secondary" type="button" data-close-modal="project">Cancel</button>
        </div>
      </form>
    </aside>
  </div>

  <script>
    (() => {
      const championModal = document.getElementById("champion-modal");
      const projectModal = document.getElementById("project-modal");
      const modalLookup = {
        champion: championModal,
        project: projectModal,
      };

      const openModal = (key) => {
        const modal = modalLookup[key];
        if (!modal) return;
        modal.hidden = false;
        document.body.classList.add("no-scroll");
      };

      const closeModal = (key) => {
        const modal = modalLookup[key];
        if (!modal) return;
        modal.hidden = true;
        if (Object.values(modalLookup).every((current) => !current || current.hidden)) {
          document.body.classList.remove("no-scroll");
        }
      };

      document.querySelectorAll("[data-open-modal]").forEach((button) => {
        button.addEventListener("click", () => openModal(button.dataset.openModal));
      });

      document.querySelectorAll("[data-close-modal]").forEach((button) => {
        button.addEventListener("click", () => closeModal(button.dataset.closeModal));
      });

      document.addEventListener("keydown", (event) => {
        if (event.key !== "Escape") return;
        Object.entries(modalLookup).forEach(([key, modal]) => {
          if (modal && !modal.hidden) {
            closeModal(key);
          }
        });
      });

      const openOnLoad = {{ (open_modal or "") | tojson }};
      if (openOnLoad === "champion" || openOnLoad === "project") {
        openModal(openOnLoad);
      }
    })();
  </script>
{% endblock %}
