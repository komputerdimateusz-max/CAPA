{% extends "layout.html" %}
{% block content %}
  <div class="settings-page">
    <section class="card settings-section-card">
      <div class="settings-subpage-header">
        <a class="button secondary" href="/ui/settings">‚Üê Back to Settings</a>
      </div>
      <h2>Assembly Lines</h2>
      <button class="button" type="button" data-open-modal="assembly-line-add">Add assembly line</button>
      {% include "partials/flash_message.html" %}

      {% if assembly_lines %}
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr><th>Line number</th><th class="num-col">CT avg (s)</th><th class="num-col">HC avg</th><th class="num-col">Unit labour cost avg [PLN]</th><th class="num-col">Material cost avg [PLN]</th><th class="num-col">Outcome cost avg [PLN]</th><th>References (N)</th><th>Edit line</th></tr>
            </thead>
            <tbody>
              {% for assembly_line in assembly_lines %}
                <tr>
                  <td>{{ assembly_line.line_number }}</td>
                  <td class="num-col">{{ '%.2f'|format(assembly_line.ct_seconds or 0) }}</td>
                  <td class="num-col">{{ '%.2f'|format(assembly_line.hc_total or 0) }}</td>
                  <td class="num-col">{{ '%.2f'|format(assembly_line.unit_labour_cost or 0) }}</td>
                  <td class="num-col">{{ '%.2f'|format(assembly_line.material_cost or 0) }}</td>
                  <td class="num-col">{{ '%.2f'|format(assembly_line.material_out_cost or 0) }}</td>
                  <td><a href="/ui/settings/assembly-lines/{{ assembly_line.id }}/references">{{ assembly_line.reference_count or 0 }}</a></td>
                  <td><a class="button secondary" href="/ui/settings/assembly-lines?assembly_line_id={{ assembly_line.id }}">Edit</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="muted">No assembly lines yet. Use Add assembly line to create one.</p>
      {% endif %}
    </section>
  </div>

  <div class="modal-shell" id="assembly-line-add-modal" hidden>
    <div class="modal-backdrop settings-modal-backdrop" data-close-modal="assembly-line-add"></div>
    <aside class="create-action-panel settings-modal-panel">
      <div class="create-action-header">
        <h3>Add assembly line</h3>
        <button class="button secondary" type="button" data-close-modal="assembly-line-add">Cancel</button>
      </div>
      <form class="form-grid" method="post" action="/ui/settings/assembly-lines">
        <label>Line number<input type="text" name="line_number" required value="{{ form.assembly_line_number or '' }}" /></label>
        <label>CT legacy (s)<input type="number" name="ct_seconds" min="0" step="0.1" required value="{{ form.assembly_ct_seconds or '' }}" /></label>
        <h5>HC legacy (by function)</h5>
        {% for worker_type in worker_types %}
        <label>{{ worker_type }} HC<input type="number" name="hc_{{ worker_type.lower() }}" min="0" step="0.01" value="{{ form['hc_' ~ worker_type.lower()] if ('hc_' ~ worker_type.lower()) in form else 0 }}" /></label>
        {% endfor %}
        <div class="form-actions"><button class="button" type="submit">Save</button><button class="button secondary" type="button" data-close-modal="assembly-line-add">Cancel</button></div>
      </form>
    </aside>
  </div>

  {% if selected_assembly_line %}
    <div class="modal-shell" id="assembly-line-edit-modal" hidden>
      <div class="modal-backdrop settings-modal-backdrop" data-close-modal="assembly-line-edit"></div>
      <aside class="create-action-panel settings-modal-panel">
        <div class="create-action-header">
          <h3>Edit assembly line</h3>
          <button class="button secondary" type="button" data-close-modal="assembly-line-edit">Cancel</button>
        </div>
        <form class="form-grid" method="post" action="/ui/settings/assembly-lines/{{ selected_assembly_line.id }}">
          <label>Line number<input type="text" name="line_number" required value="{{ form.assembly_line_number or selected_assembly_line.line_number }}" /></label>
          <label>CT legacy (s)<input type="number" name="ct_seconds" min="0" step="0.1" required value="{{ form.assembly_ct_seconds or selected_assembly_line.ct_seconds }}" /></label>
          <h5>HC legacy (by function)</h5>
          {% for worker_type in worker_types %}
          <label>{{ worker_type }} HC<input type="number" name="hc_{{ worker_type.lower() }}" min="0" step="0.01" value="{{ form['hc_' ~ worker_type.lower()] if ('hc_' ~ worker_type.lower()) in form else selected_assembly_line_hc_map.get(worker_type, 0) }}" /></label>
          {% endfor %}
          <div class="form-actions"><button class="button" type="submit">Save</button><button class="button secondary" type="button" data-close-modal="assembly-line-edit">Cancel</button></div>
        </form>
        <form method="post" action="/ui/settings/assembly-lines/{{ selected_assembly_line.id }}/delete">
          <button class="button secondary" type="submit">Delete</button>
        </form>
      </aside>
    </div>
  {% endif %}

  <script>
    (() => {
      const bindModal = (name) => {
        const modal = document.getElementById(`${name}-modal`);
        if (!modal) return;
        const openModal = () => { modal.hidden = false; document.body.classList.add("no-scroll"); };
        const closeModal = () => { modal.hidden = true; document.body.classList.remove("no-scroll"); };
        document.querySelectorAll(`[data-open-modal="${name}"]`).forEach((button) => button.addEventListener("click", openModal));
        document.querySelectorAll(`[data-close-modal="${name}"]`).forEach((button) => button.addEventListener("click", closeModal));
        return openModal;
      };

      const openAddModal = bindModal("assembly-line-add");
      const openEditModal = bindModal("assembly-line-edit");
      if ({{ (open_modal == "assembly-line-add") | tojson }}) openAddModal && openAddModal();
      if ({{ (open_modal == "assembly-line-edit") | tojson }} || {{ (selected_assembly_line is not none) | tojson }}) {
        openEditModal && openEditModal();
      }
    })();
  </script>
{% endblock %}
