{% extends "layout.html" %}
{% block content %}
  <div class="settings-page">
    <section class="card settings-section-card">
      <div class="settings-subpage-header">
        <a class="button secondary" href="/ui/settings">← Back to Settings</a>
        <button class="button" type="button" data-open-modal="material">Add material</button>
      </div>
      <h2>Materials</h2>
      {% include "partials/flash_message.html" %}

      {% if materials %}
        <div class="table-wrap">
          <table class="table">
            <thead><tr><th>Part number</th><th>Description</th><th>Unit</th><th>Price / unit [PLN]</th><th>Category</th><th>Make/BUY</th><th>Edit</th></tr></thead>
            <tbody>
              {% for material in materials %}
                <tr>
                  <td>{{ material.part_number }}</td>
                  <td>{{ material.description or '—' }}</td>
                  <td>{{ material.unit }}</td>
                  <td>{{ '%.2f'|format(material.price_per_unit) if material.price_per_unit is not none else '—' }}</td>
                  <td>{{ material.category }}</td>
                  <td>{{ 'MAKE' if material.make_buy else 'BUY' }}</td>
                  <td><a class="button secondary" href="/ui/settings/materials?material_id={{ material.id }}">Edit</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="muted">No materials yet. Use Add material to create one.</p>
      {% endif %}
    </section>
  </div>

  <div class="modal-shell" id="material-modal" hidden><div class="modal-backdrop settings-modal-backdrop" data-close-modal="material"></div><aside class="create-action-panel settings-modal-panel"><div class="create-action-header"><h3>Add material</h3><button class="button secondary" type="button" data-close-modal="material">Cancel</button></div><form class="form-grid" method="post" action="/ui/settings/materials"><label>Part number<input type="text" name="part_number" required value="{{ form.part_number or '' }}" /></label><label>Description<input type="text" name="description" value="{{ form.description or '' }}" /></label><label>Unit<input type="text" name="unit" required value="{{ form.unit or '' }}" /></label><label data-price-field>Price per unit [PLN]<input type="number" name="price_per_unit" data-price-input min="0" step="0.01" value="{{ form.price_per_unit or '' }}" /></label><p class="muted" data-make-price-info hidden>MAKE material price is calculated from process outcome (labour + material input).</p><label>Category<select name="category" required>{% set selected_category = form.category or 'Raw material' %}{% for category_option in material_category_options %}<option value="{{ category_option }}" {% if category_option == selected_category %}selected{% endif %}>{{ category_option }}</option>{% endfor %}</select></label><label style="display:flex;align-items:center;gap:0.5rem;"><input type="checkbox" name="make_buy" value="1" data-make-buy-toggle {% if (form.make_buy or '') in ['1', 'true', 'on', 'yes'] %}checked{% endif %} />Make/BUY: <strong data-make-buy-label>BUY</strong></label><div class="form-actions"><button class="button" type="submit">Save material</button><button class="button secondary" type="button" data-close-modal="material">Cancel</button></div></form></aside></div>

  {% if selected_material %}
    <div class="modal-shell" id="material-edit-modal" hidden><div class="modal-backdrop settings-modal-backdrop" data-close-modal="material-edit"></div><aside class="create-action-panel settings-modal-panel"><div class="create-action-header"><h3>Edit material</h3><button class="button secondary" type="button" data-close-modal="material-edit">Cancel</button></div><form class="form-grid" method="post" action="/ui/settings/materials/{{ selected_material.id }}"><label>Part number<input type="text" name="part_number" required value="{{ form.part_number or selected_material.part_number }}" /></label><label>Description<input type="text" name="description" value="{{ form.description or selected_material.description or '' }}" /></label><label>Unit<input type="text" name="unit" required value="{{ form.unit or selected_material.unit }}" /></label><label data-price-field>Price per unit [PLN]<input type="number" name="price_per_unit" data-price-input min="0" step="0.01" value="{{ form.price_per_unit if form.price_per_unit is defined else (selected_material.price_per_unit if selected_material.price_per_unit is not none else '') }}" /></label><p class="muted" data-make-price-info hidden>MAKE material price is calculated from process outcome (labour + material input).</p><label>Category<select name="category" required>{% set selected_edit_category = form.category or selected_material.category %}{% for category_option in material_category_options %}<option value="{{ category_option }}" {% if category_option == selected_edit_category %}selected{% endif %}>{{ category_option }}</option>{% endfor %}</select></label><label style="display:flex;align-items:center;gap:0.5rem;"><input type="checkbox" name="make_buy" value="1" data-make-buy-toggle {% if (form.make_buy or ('1' if selected_material.make_buy else '0')) in ['1', 'true', 'on', 'yes'] %}checked{% endif %} />Make/BUY: <strong data-make-buy-label>BUY</strong></label><div class="form-actions"><button class="button" type="submit">Save material</button><button class="button secondary" type="button" data-close-modal="material-edit">Cancel</button></div></form><form method="post" action="/ui/settings/materials/{{ selected_material.id }}/delete"><button class="button secondary" type="submit">Delete material</button></form></aside></div>
  {% endif %}

  <script>(()=>{const materialModal=document.getElementById("material-modal");const openMaterial=()=>{materialModal.hidden=false;document.body.classList.add("no-scroll")};const closeMaterial=()=>{materialModal.hidden=true;document.body.classList.remove("no-scroll")};document.querySelectorAll('[data-open-modal="material"]').forEach((button)=>button.addEventListener("click",openMaterial));document.querySelectorAll('[data-close-modal="material"]').forEach((button)=>button.addEventListener("click",closeMaterial));if({{ (open_modal == "material") | tojson }})openMaterial();const materialEditModal=document.getElementById("material-edit-modal");if(materialEditModal){const openMaterialEdit=()=>{materialEditModal.hidden=false;document.body.classList.add("no-scroll")};const closeMaterialEdit=()=>{materialEditModal.hidden=true;document.body.classList.remove("no-scroll")};document.querySelectorAll('[data-close-modal="material-edit"]').forEach((button)=>button.addEventListener("click",closeMaterialEdit));if({{ ((selected_material is not none and open_modal != "material") or open_modal == "material-edit") | tojson }})openMaterialEdit();}const syncMakeBuyState=()=>{document.querySelectorAll('[data-make-buy-toggle]').forEach((toggle)=>{const scope=toggle.closest('form');const label=toggle.closest('label')?.querySelector('[data-make-buy-label]');if(label){label.textContent=toggle.checked?'MAKE':'BUY';}if(!scope)return;const priceField=scope.querySelector('[data-price-field]');const priceInput=scope.querySelector('[data-price-input]');const info=scope.querySelector('[data-make-price-info]');if(!priceField||!priceInput||!info)return;if(toggle.checked){priceField.hidden=true;priceInput.required=false;priceInput.disabled=true;priceInput.value='';info.hidden=false;}else{priceField.hidden=false;priceInput.required=true;priceInput.disabled=false;info.hidden=true;}});};document.querySelectorAll('[data-make-buy-toggle]').forEach((toggle)=>toggle.addEventListener('change',syncMakeBuyState));syncMakeBuyState();})();</script>
{% endblock %}
