{% extends "layout.html" %}
{% block content %}
  <div class="settings-page">
    <section class="card settings-section-card">
      <div class="settings-subpage-header">
        <a class="button secondary" href="/ui/settings">← Back to Settings</a>
        <button class="button" type="button" data-open-modal="moulding-machine">Add moulding machine</button>
      </div>
      <h2>Moulding Machines</h2>
      {% include "partials/flash_message.html" %}

      {% if moulding_machines %}
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr><th>Machine number</th><th>Tonnage</th><th>Tools assigned</th><th></th></tr>
            </thead>
            <tbody>
              {% for machine in moulding_machines %}
                <tr>
                  <td>{{ machine.machine_number }}</td>
                  <td>{{ machine.tonnage if machine.tonnage is not none else '—' }}</td>
                  <td>{% set tool_count = machine.tools | length %}{% if tool_count > 0 %}<a href="/ui/settings/moulding-machines/{{ machine.id }}/tools">{{ tool_count }}</a>{% else %}0{% endif %}</td>
                  <td><a class="button secondary" href="/ui/settings/moulding-machines?machine_id={{ machine.id }}">Edit</a></td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="muted">No moulding machines yet. Use Add moulding machine to create one.</p>
      {% endif %}

      {% if selected_moulding_machine %}
        <div class="card settings-inline-card">
          <h4>Edit moulding machine</h4>
          <form class="form-grid" method="post" action="/ui/settings/moulding-machines/{{ selected_moulding_machine.id }}">
            <label>Machine number<input type="text" name="machine_number" required value="{{ form.machine_number or selected_moulding_machine.machine_number }}" /></label>
            <label>Tonnage<input type="number" name="tonnage" min="0" step="1" value="{{ form.machine_tonnage or (selected_moulding_machine.tonnage if selected_moulding_machine.tonnage is not none else '') }}" /></label>
            <div class="form-actions"><button class="button" type="submit">Save moulding machine</button></div>
          </form>

          <div class="assignment-widget">
            <h5>Tools assigned</h5>
            {% if moulding_tools %}
              <form class="assignment-add-form" method="post" action="/ui/settings/moulding-machines/{{ selected_moulding_machine.id }}/tools/add">
                <input name="tool_pn" list="moulding-tool-options" placeholder="Type tool P/N" autocomplete="off" required />
                <datalist id="moulding-tool-options">
                  {% for tool in moulding_tools %}
                    <option value="{{ tool.tool_pn }}">{{ tool.tool_pn }}{% if tool.description %} — {{ tool.description }}{% endif %} (CT {{ tool.ct_seconds }}s)</option>
                  {% endfor %}
                </datalist>
                <button class="button secondary" type="submit">Add tool</button>
              </form>
              <small class="muted">Start typing to search, then click Add.</small>
            {% else %}
              <p class="muted">No tools defined yet. Add them in Settings → Moulding Tools.</p>
            {% endif %}

            <div class="assignment-chips">
              {% for tool in selected_moulding_machine.tools %}
                <span class="chip assignment-chip">{{ tool.tool_pn }}
                  <form method="post" action="/ui/settings/moulding-machines/{{ selected_moulding_machine.id }}/tools/remove">
                    <input type="hidden" name="tool_id" value="{{ tool.id }}" />
                    <button class="assignment-remove" type="submit" aria-label="Remove tool">×</button>
                  </form>
                </span>
              {% else %}
                <small class="muted">No moulding tools assigned.</small>
              {% endfor %}
            </div>
          </div>

          <form method="post" action="/ui/settings/moulding-machines/{{ selected_moulding_machine.id }}/delete">
            <button class="button secondary" type="submit">Delete moulding machine</button>
          </form>
        </div>
      {% endif %}
    </section>
  </div>

  <div class="modal-shell" id="moulding-machine-modal" hidden><div class="modal-backdrop settings-modal-backdrop" data-close-modal="moulding-machine"></div><aside class="create-action-panel settings-modal-panel"><div class="create-action-header"><h3>Add moulding machine</h3><button class="button secondary" type="button" data-close-modal="moulding-machine">Cancel</button></div><form class="form-grid" method="post" action="/ui/settings/moulding-machines"><label>Machine number<input type="text" name="machine_number" required value="{{ form.machine_number or '' }}" /></label><label>Tonnage<input type="number" name="tonnage" min="0" step="1" value="{{ form.machine_tonnage or '' }}" /></label><label>Tools assigned{% set create_machine_tool_ids = form.machine_tool_ids.split(',') if form.machine_tool_ids else [] %}{% if moulding_tools %}<select name="tool_ids" multiple size="5">{% for tool in moulding_tools %}<option value="{{ tool.id }}" {% if tool.id|string in create_machine_tool_ids %}selected{% endif %}>{{ tool.tool_pn }}</option>{% endfor %}</select>{% else %}<p class="muted">Add moulding tools first.</p>{% endif %}</label><div class="form-actions"><button class="button" type="submit">Save moulding machine</button><button class="button secondary" type="button" data-close-modal="moulding-machine">Cancel</button></div></form></aside></div>
  <script>(()=>{const modal=document.getElementById("moulding-machine-modal");const openModal=()=>{modal.hidden=false;document.body.classList.add("no-scroll")};const closeModal=()=>{modal.hidden=true;document.body.classList.remove("no-scroll")};document.querySelectorAll('[data-open-modal="moulding-machine"]').forEach((button)=>button.addEventListener("click",openModal));document.querySelectorAll('[data-close-modal="moulding-machine"]').forEach((button)=>button.addEventListener("click",closeModal));if({{ (open_modal == "moulding-machine") | tojson }})openModal();})();</script>
{% endblock %}
