{% extends "layout.html" %}
{% block content %}
  <div class="settings-page"><section class="card settings-section-card"><div class="settings-subpage-header"><a class="button secondary" href="/ui/settings">← Back to Settings</a><button class="button" type="button" data-open-modal="moulding-tool">Add moulding tool</button></div><h2>Moulding Tools</h2>{% include "partials/flash_message.html" %}
  {% if moulding_tools %}<div class="table-wrap"><table class="table"><thead><tr><th>Tool P/N</th><th>Description</th><th>CT (s)</th><th>HC total</th><th>Unit labour cost [PLN]</th><th></th></tr></thead><tbody>{% for tool in moulding_tools %}<tr><td>{{ tool.tool_pn }}</td><td>{{ tool.description or '—' }}</td><td>{{ tool.ct_seconds }}</td><td>{{ '%.2f'|format(tool.hc_total or 0) }}</td><td>{{ '%.2f'|format(tool.unit_labour_cost or 0) }}</td><td><a class="button secondary" href="/ui/settings/moulding-tools?tool_id={{ tool.id }}">Edit</a></td></tr>{% endfor %}</tbody></table></div>{% else %}<p class="muted">No moulding tools yet. Use Add moulding tool to create one.</p>{% endif %}
  {% if selected_moulding_tool %}<div class="card settings-inline-card"><h4>Edit moulding tool</h4><form class="form-grid" method="post" action="/ui/settings/moulding-tools/{{ selected_moulding_tool.id }}"><label>Tool P/N<input type="text" name="tool_pn" required value="{{ form.tool_pn or selected_moulding_tool.tool_pn }}" /></label><label>Description<input type="text" name="description" value="{{ form.tool_description or selected_moulding_tool.description or '' }}" /></label><label>CT (s)<input type="number" name="ct_seconds" min="0" step="0.01" required value="{{ form.tool_ct_seconds or selected_moulding_tool.ct_seconds }}" /></label><h5>HC (by function)</h5>{% for worker_type in worker_types %}<label>{{ worker_type }} HC<input type="number" name="hc_{{ worker_type.lower() }}" min="0" step="0.01" value="{{ form['hc_' ~ worker_type.lower()] if ('hc_' ~ worker_type.lower()) in form else selected_moulding_tool_hc_map.get(worker_type, 0) }}" /></label>{% endfor %}<div class="form-actions"><button class="button" type="submit">Save moulding tool</button></div></form><form method="post" action="/ui/settings/moulding-tools/{{ selected_moulding_tool.id }}/delete"><button class="button secondary" type="submit">Delete moulding tool</button></form></div>{% endif %}
  </section></div>
  <div class="modal-shell" id="moulding-tool-modal" hidden><div class="modal-backdrop settings-modal-backdrop" data-close-modal="moulding-tool"></div><aside class="create-action-panel settings-modal-panel"><div class="create-action-header"><h3>Add moulding tool</h3><button class="button secondary" type="button" data-close-modal="moulding-tool">Cancel</button></div><form class="form-grid" method="post" action="/ui/settings/moulding-tools"><label>Tool P/N<input type="text" name="tool_pn" required value="{{ form.tool_pn or '' }}" /></label><label>Description<input type="text" name="description" value="{{ form.tool_description or '' }}" /></label><label>CT (s)<input type="number" name="ct_seconds" min="0" step="0.01" required value="{{ form.tool_ct_seconds or '' }}" /></label><h5>HC (by function)</h5>{% for worker_type in worker_types %}<label>{{ worker_type }} HC<input type="number" name="hc_{{ worker_type.lower() }}" min="0" step="0.01" value="{{ form['hc_' ~ worker_type.lower()] if ('hc_' ~ worker_type.lower()) in form else 0 }}" /></label>{% endfor %}<div class="form-actions"><button class="button" type="submit">Save</button><button class="button secondary" type="button" data-close-modal="moulding-tool">Cancel</button></div></form></aside></div>
  <script>(()=>{const modal=document.getElementById("moulding-tool-modal");const openModal=()=>{modal.hidden=false;document.body.classList.add("no-scroll")};const closeModal=()=>{modal.hidden=true;document.body.classList.remove("no-scroll")};document.querySelectorAll('[data-open-modal="moulding-tool"]').forEach((button)=>button.addEventListener("click",openModal));document.querySelectorAll('[data-close-modal="moulding-tool"]').forEach((button)=>button.addEventListener("click",closeModal));if({{ (open_modal == "moulding-tool") | tojson }})openModal();})();</script>
{% endblock %}
